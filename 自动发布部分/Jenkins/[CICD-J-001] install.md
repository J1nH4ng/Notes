# [CICD-J-001] Jenkins 的安装配置

## Jenkins 服务器所需软件列表

### 运行 Jenkins 需要

- [ ] Jenkins
- [ ] Jdk 17+ （Jenkins 运行需要）

### 业务需要

- [ ] Maven
    - [ ] 修改 Maven 源
- [ ] Jdk 8 （与业务代码所需 Java 版本一致）
- [ ] NVM （管理 NodeJS 版本）
    - [ ] NodeJS 10.24.1
    - [ ] NodeJS 12.22.12
    - [ ] NodeJS 14.21.3
    - [ ] NodeJS 16.20.2
    - [ ] NodeJS 18.20.5
    - [ ] NodeJS 20.18.1
- [ ] 代码凭据配置配置（拉取代码需要）
    - [ ] SSH-Keygen
    - [ ] GitLab 的账户密码
- [ ] Php （与业务代码所需 Php 版本一致）
    - [ ] Compress
- [ ] Ansible
    - [ ] 配置账户密码
    - [ ] 配置免密执行 sudo 命令

## Jenkins 所需插件列表

1. Localization Support
2. Localization:Chinese (Simplified)
3. Locale
4. GitLab 相关
5. Blue Ocean
6. Role-based Authorization Strategy
7. Pipeline: Stage View
8. Build Pipeline
9. Version Number

## Jenkins 安装配置

### Jenkins 服务器

#### 安装与业务一致的打包环境

##### 安装 JDK 8

由于 Oracle 为了保证 JDK 的更新而强制关闭 JDK 旧版本的登录下载；所以，对于 JDK 8 的版本来说，需要我们手动从 [Oracle Java 网站](https://www.oracle.com/cn/java/technologies/downloads/)上下载，然后上传至服务器。这里我们将 JDK 8 的压缩包上传至服务器的 `/usr/local/src/` 目录下。

```bash
cd /usr/local/src
```

解压缩预编译好的 JDK 8 压缩包，并移动到外层目录中：

```bash
tar -zxvf jdk-8u371-linux-x64.tar.gz

mv jdk1.8.0_371 /usr/local/jdk8
```

写入环境变量，便于后续打包时调用：

```bash
echo 'PATH=$PATH:/usr/local/jdk8/bin
export PATH' >> /etc/profile

echo 'JAVA_HOME=/usr/local/jdk8' >> /etc/profile
```

刷新环境变量，使其生效。

```bash
source /etc/profile
```

##### 安装并配置 Maven

###### 安装 Maven

Maven 的下载地址如下：[https://archive.apache.org/dist/maven/maven-3/](https://archive.apache.org/dist/maven/maven-3/)

选择最新版本进行下载即可。

对于服务器来说，可以使用 `wget` 命令进行下载，对于国内的服务器，使用清华源进行下载，这里我们下载至 `/usr/local/src` 目录下。

```bash
cd /usr/local/src

wget https://archive.apache.org/dist/maven/maven-3/3.9.9/binaries/apache-maven-3.9.9-bin.tar.gz
```

解压缩预编译好的 Maven 压缩包，并移动到外层目录中：

```bash
tar -zxvf apache-maven-3.9.9-bin.tar.gz

cp -r /usr/local/src/apache-maven-3.9.9 /usr/local/maven3.9
```

写入环境变量，便于后续打包时调用：

```bash
echo '
PATH=$PATH:/usr/local/maven3.9/bin
export PATH' >> /etc/profile
```

刷新环境变量，使其生效。

```bash
source /etc/profile
```

###### 配置 Maven

需要配置的内容有以下两点：

1. 修改镜像源地址为国内源
2. 配置私人镜像源地址

修改 Maven 配置文件：

```bash
vim /usr/local/maven3.9/conf/settings.xml
```

添加如下内容：

```diff
...
<servers>
+    <server>
+        <id>self-hosted-nexus</id>
+        <username>${username}</username>
+        <password>${password}</password> 
+    </server>
</servers>

...

<mirrors>
+    <mirror>
+        <id>self-hosted-nexus</id>
+        <mirrorOf>*</mirrorOf>
+        <name>self-hosted-nexus</name>
+        <url>${url}</url>
+    </mirror>
+    <mirror>
+        <id>aliyun-maven</id>
+        <mirrorOf>*</mirrorOf>
+        <url>https://maven.aliyun.com/repository/public/</url>
+    </mirror>
</mirrors>

...
```

将这里的 `${username}` 和 `${password}` 替换为私有仓库的账户密码，将 `${url}` 替换为可以被访问到的地址。

##### 安装 NodeJS

###### 安装 NVM

NVM 的下载地址如下：[https://github.com/nvm-sh/nvm](https://github.com/nvm-sh/nvm)

选择最新版本进行下载即可。

对于服务器来说，可以使用 `wget` 命令进行下载，对于国内的服务器，使用清华源进行下载，这里我们下载至 `/usr/local/src` 目录下。

```bash
cd /usr/local/src

wget https://github.com/nvm-sh/nvm/archive/refs/tags/v0.40.1.tar.gz -O nvm-0.40.1.tar.gz
```

解压缩预编译好的 NVM 压缩包，并移动到外层目录中：

```bash
tar -zxvf nvm-0.40.1.tar.gz
mv nvm-0.40.1 /usr/local/nvm0.40
```

添加到 Bash 的配置文件中：

```bash
echo "source /usr/local/nvm0.40/nvm.sh" >> ~/.bashrc
```

刷新 Bash 的配置，使其生效：

```bash
source ~/.bashrc
```

###### 安装多个版本的 NodeJS

使用 NVM 安装 NodeJS 时，无法查询到 NodeJS 版本，只有 io.js 版本，这是因为 NVM 无法连接至 NodeJS 版本服务器导致的，可以指定服务器进行版本安装。

```bash
NVM_NODEJS_ORG_MIRROR=https://nodejs.org/dist nvm install <nodejs_version>

# or

NVM_NODEJS_ORG_MIRROR=https://npmmirror.com/mirrors/node/ nvm install <nodejs_version>
```

使用 NVM 安装各个 NodeJS 稳定版：

```bash
nvm install v10.24.1
nvm install v12.22.12
nvm install v14.21.3
nvm install v16.20.2
nvm install v18.20.5
nvm install v20.18.1
```

##### 安装并配置 PHP

[!TODO]

#### 安装并配置 Jenkins

##### 安装 Jenkins 所需运行时

Jenkins 新版本需要 JDK 17 及以上，这里我们手动从 [Oracle Java 网站](https://www.oracle.com/cn/java/technologies/downloads/)上下载最新的 JDK 版本，然后上传至服务器的 `/usr/local/src/` 目录下。

```bash
cd /usr/local/src
```

解压缩预编译好的 JDK 21 压缩包，并移动到外层目录中：

```bash
tar -zxvf jdk-21-linux-x64.tar.gz

mv jdk21 /usr/local/jdk21
```

这里我们不将 JDK 21 写入到环境变量中，以免调用 JDK 环境打包时使用错误的 JDK 环境，在 Jenkins 启动时使用绝对路径来使用 JDK 21。

##### 安装 Jenkins

下载 Jenkins 的 RedHat 发行版的安装包，国内的服务器使用清华源进行下载。

```bash
cd /usr/local/src

wget https://mirrors.tuna.tsinghua.edu.cn/jenkins/redhat/jenkins-2.491-1.1.noarch.rpm --no-check-certificate
```

安装二进制安装包

```bash
rpm -ivh jenkins-2.491-1.1.noarch.rpm
```

##### 配置 Jenkins

修改 Jenkins 的启动配置文件

```bash
vim /usr/lib/systemd/system/jenkins.service
```

修改如下内容：

```diff
#
# This file is managed by systemd(1). Do NOT edit this file manually!
# To override these settings, run:
#
#     systemctl edit jenkins
#
# For more information about drop-in files, see:
#
#     https://www.freedesktop.org/software/systemd/man/systemd.unit.html
#

[Unit]
Description=Jenkins Continuous Integration Server
Requires=network.target
After=network.target
StartLimitBurst=5
StartLimitIntervalSec=5m

[Service]
Type=notify
NotifyAccess=main
ExecStart=/usr/bin/jenkins
Restart=on-failure
SuccessExitStatus=143

# Configures the time to wait for start-up. If Jenkins does not signal start-up
# completion within the configured time, the service will be considered failed
# and will be shut down again. Takes a unit-less value in seconds, or a time span
# value such as "5min 20s". Pass "infinity" to disable the timeout logic.
#TimeoutStartSec=90

# Unix account that runs the Jenkins daemon
# Be careful when you change this, as you need to update the permissions of
# $JENKINS_HOME, $JENKINS_LOG, and (if you have already run Jenkins)
# $JENKINS_WEBROOT.
- User=jenkins
+ User=root
- Group=jenkins
+ Group=root

# Directory where Jenkins stores its configuration and workspaces
- Environment="JENKINS_HOME=/var/lib/jenkins"
+ Environment="JENKINS_HOME=/data/jenkins"
- WorkingDirectory=/var/lib/jenkins
+ WorkingDirectory=/data/jenkins

# Location of the Jenkins WAR
#Environment="JENKINS_WAR=/usr/share/java/jenkins.war"

# Location of the exploded WAR
Environment="JENKINS_WEBROOT=%C/jenkins/war"

# Location of the Jenkins log. By default, systemd-journald(8) is used.
#Environment="JENKINS_LOG=%L/jenkins/jenkins.log"

# The Java home directory. When left empty, JENKINS_JAVA_CMD and PATH are consulted.
#Environment="JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64"
+ Environment="JAVA_HOME=/usr/local/jdk21"

# The Java executable. When left empty, JAVA_HOME and PATH are consulted.
#Environment="JENKINS_JAVA_CMD=/etc/alternatives/java"

# Arguments for the Jenkins JVM
Environment="JAVA_OPTS=-Djava.awt.headless=true"

# Unix Domain Socket to listen on for local HTTP requests. Default is disabled.
#Environment="JENKINS_UNIX_DOMAIN_PATH=/run/jenkins/jenkins.socket"

# IP address to listen on for HTTP requests.
# The default is to listen on all interfaces (0.0.0.0).
#Environment="JENKINS_LISTEN_ADDRESS="

# Port to listen on for HTTP requests. Set to -1 to disable.
# To be able to listen on privileged ports (port numbers less than 1024),
# add the CAP_NET_BIND_SERVICE capability to the AmbientCapabilities
# directive below.
Environment="JENKINS_PORT=8080"

# IP address to listen on for HTTPS requests. Default is disabled.
#Environment="JENKINS_HTTPS_LISTEN_ADDRESS="

# Port to listen on for HTTPS requests. Default is disabled.
# To be able to listen on privileged ports (port numbers less than 1024),
# add the CAP_NET_BIND_SERVICE capability to the AmbientCapabilities
# directive below.
#Environment="JENKINS_HTTPS_PORT=443"

# Path to the keystore in JKS format (as created by the JDK's keytool).
# Default is disabled.
#Environment="JENKINS_HTTPS_KEYSTORE=/path/to/keystore.jks"

# Password to access the keystore defined in JENKINS_HTTPS_KEYSTORE.
# Default is disabled.
#Environment="JENKINS_HTTPS_KEYSTORE_PASSWORD=s3cR3tPa55w0rD"

# IP address to listen on for HTTP2 requests. Default is disabled.
#Environment="JENKINS_HTTP2_LISTEN_ADDRESS="

# HTTP2 port to listen on. Default is disabled.
# To be able to listen on privileged ports (port numbers less than 1024),
# add the CAP_NET_BIND_SERVICE capability to the AmbientCapabilities
# directive below.
#Environment="JENKINS_HTTP2_PORT="

# Controls which capabilities to include in the ambient capability set for the
# executed process. Takes a whitespace-separated list of capability names, e.g.
# CAP_SYS_ADMIN, CAP_DAC_OVERRIDE, CAP_SYS_PTRACE. Ambient capability sets are
# useful if you want to execute a process as a non-privileged user but still
# want to give it some capabilities. For example, add the CAP_NET_BIND_SERVICE
# capability to be able to listen on privileged ports (port numbers less than
# 1024).
#AmbientCapabilities=CAP_NET_BIND_SERVICE

# Debug level for logs. The higher the value, the more verbose. 5 is INFO.
#Environment="JENKINS_DEBUG_LEVEL=5"

# Set to true to enable logging to /var/log/jenkins/access_log.
#Environment="JENKINS_ENABLE_ACCESS_LOG=false"

# Servlet context (important if you want to use reverse proxying)
#Environment="JENKINS_PREFIX=/jenkins"

# Arbitrary additional arguments to pass to Jenkins.
# Full option list: java -jar jenkins.war --help
#Environment="JENKINS_OPTS="

# Maximum core file size. If unset, the value from the OS is inherited.
#LimitCORE=infinity

# Maximum file size. If unset, the value from the OS is inherited.
#LimitFSIZE=infinity

# File descriptor limit. If unset, the value from the OS is inherited.
#LimitNOFILE=8192

# Maximum number of processes. If unset, the value from the OS is inherited.
#LimitNPROC=32768

# Set the umask to control the permission bits of files that Jenkins creates.
#
# 0027 makes files read-only for group and inaccessible for others, which some
# security sensitive users might consider beneficial, especially if Jenkins
# is running on a server that is used for multiple purposes. Beware that 0027
# permissions would interfere with sudo scripts that run on the controller
# (see JENKINS-25065).
#
# Note also that the particularly sensitive parts of $JENKINS_HOME (such as
# credentials) are always written without 'other' access. So the umask values
# only affect job configuration, build records, etc.
#
# If unset, the value from the OS is inherited, which is normally 0022.
# The default umask comes from pam_umask(8) and /etc/login.defs.
#UMask=0022

[Install]
WantedBy=multi-user.target
```

修改完成后，重新载入配置文件

```bash
systemctl daemon-reload
```

这里修改了 Jenkins 的工作目录在 `/data` 路径下，需要手动创建该目录：

```bash
mkdir -p /data/jenkins
```

创建完成后，运行 Jenkins

```bash
systemctl enable jenkins --now
```

使用如下命令查看运行情况：

```bash
systemctl status jenkins
```

运行成功后，可以在同一局域网服务器内，通过该 Jenkins 服务器 IP 地址 + 8080 端口号访问 Jenkins 的 Web 界面。

默认密码使用如下命令查看：

```bash
cat /data/jenkins/secrets/initialAdminPassword
```

Jenkins 默认下载源国内下载较慢，需要修改成清华源：

```bash
vim /data/jenkins/hudson.model.UpdateCenter.xml
```

修改如下内容：

```diff
<?xml version='1.1' encoding='UTF-8'?>
<sites>
    <site>
        <id>default</id>
-       <url>https://updates.jenkins.io/update-center.json</url>
+       <url>https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json</url>
    </site>
</sites>
```

在安装完成 Jenkins 后，启动时需要的目录就已经生成完毕了，其中的更新地址依旧为 `update.jenkins.io` ,仍然需要修改为国内源：

```bash
cd /data/jenkins/updates

sed -i 's#updates.jenkins.io/download/plugins#mirrors.tuna.tsinghua.edu.cn/jenkins/plugins#g' default.json

sed -i 's#www.google.com#www.bilibili.com#g' default.json
```

#### 配置代码拉取凭据

##### 使用 SSH 协议拉取

Jenkins 如果可以使用 SSH 协议进行代码拉取，可以将本机的 SSH 的公钥配置在 Git 服务器上。

首先生成 SSH-Keygen，由于安全考虑，Github 已经不允许基于 RSA2048 算法的密钥生成，这里使用 ed25519 算法，如果服务器无法支持该算法，可以使用 RSA4096 算法

```bash
ssh-keygen -t ed25519 -C "deploy_email@example.com"

# or

ssh-keygen -t rsa -b 4096 -C "deploy_email@example.com"
```

当系统提示“输入要存储密钥的文件”时，可以使用回车结束默认文件的位置，如果之前创建过了，ssh-keygen 可能会要求你重写密钥，这种情况下，可以对刚刚创建的文件进行自定义命名。此时，可以修改 `.gitconfig` 文件，来指定使用哪个密钥来进行代码的拉取。这里我们假定刚刚生成的密钥命名为 `id_rsa_gitlab` 和 `id_rsa_gitlab.pub`


修改 ssh 的配置文件：

```bash
vim /root/.ssh/config
```

写入如下内容：

```bash
Host self-hosted-gitlab
  HostName gitlab.example.com
  User git
  IdentityFile /root/.ssh/id_rsa_gitlab
  IdentitiesOnly yes
```

同时，需要将 `id_rsa_gitlab.pub` 文件中的内容配置在 GitLab 服务器上。

##### 使用 HTTP 协议拉取

当不能使用 SSH 协议拉取代码时，需要配置 Git 仓库的登录凭据。

在 Jenkins Web 界面上，依照如下顺序进行点击：

[系统管理] -> [凭据] -> 最底部的 [System] -> [全局凭据 (unrestricted)] -> [+ Add Credentials]

凭据的类型选择：`Username with password`，根据具体的信息进行填写 Git 服务器的用户名和地址。